{
  "metadata": {
    "version": "3.0.0",
    "generatedAt": "2026-01-14T09:25:11+08:00",
    "tool": "Claude Code (Sonnet 4.5, 增量扫描初始化)",
    "projectName": "top1000",
    "description": "PT站点资源追踪系统 - Go + Fiber + Redis + AG Grid 小型Web应用"
  },
  "summary": {
    "totalFiles": 18,
    "scannedFiles": 18,
    "coveragePercent": 100,
    "truncated": false,
    "lastUpdate": "2026-01-14 - TTL机制移除与容错优化"
  },
  "modules": [
    {
      "path": "cmd/top1000",
      "name": "应用程序入口",
      "language": "Go",
      "entryPoint": "main.go",
      "responsibilities": [
        "加载环境变量（.env或系统变量）",
        "验证必需环境变量（REDIS_ADDR、REDIS_PASSWORD）",
        "启动HTTP服务器"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["main.go"],
      "documentation": "cmd/top1000/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 40,
      "interfaces": [],
      "dependencies": ["internal/server", "github.com/joho/godotenv"]
    },
    {
      "path": "internal/api",
      "name": "API 处理层",
      "language": "Go",
      "entryPoint": "handlers.go",
      "responsibilities": [
        "处理HTTP请求（/top1000.json）",
        "三层缓存策略（内存 → Redis → 触发更新）",
        "并发控制（读写锁、加载标记）",
        "容错机制（更新失败时返回旧数据，保证服务可用）",
        "返回JSON数据"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["handlers.go"],
      "documentation": "internal/api/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 227,
      "interfaces": [
        {
          "name": "GetTop1000Data",
          "type": "HTTP Handler",
          "method": "GET",
          "path": "/top1000.json",
          "description": "获取Top1000数据的API接口，支持三层缓存、按需更新、容错机制"
        }
      ],
      "dependencies": ["internal/crawler", "internal/storage", "internal/model", "github.com/gofiber/fiber/v2"],
      "optimizations": [
        "函数拆分（180行→64行主函数，-64%）",
        "panic恢复机制（goroutine安全）",
        "超时保护（10秒等待，小项目优化）",
        "双重检查模式（防止重复加载）",
        "读写锁优化（RLock/Lock正确使用）",
        "容错机制（更新失败时返回Redis旧数据，2026-01-14新增）"
      ],
      "simplificationOpportunities": [
        "缓存逻辑可抽象为独立的缓存管理器（约2小时）",
        "可添加监控指标（缓存命中率、响应时间，约2-3小时）",
        "依赖注入提高可测试性（约3-4小时，低优先级）"
      ]
    },
    {
      "path": "internal/config",
      "name": "配置管理模块",
      "language": "Go",
      "entryPoint": "config.go",
      "responsibilities": [
        "从环境变量读取配置",
        "提供默认值（PORT=7066、CACHE_DURATION=24h等）",
        "启动时验证配置（REDIS_ADDR、REDIS_PASSWORD必须）"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["config.go"],
      "documentation": "internal/config/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 103,
      "interfaces": [
        {
          "name": "Load",
          "type": "Function",
          "description": "加载配置（单例模式）"
        },
        {
          "name": "Validate",
          "type": "Function",
          "description": "验证配置有效性（检查Redis配置）"
        },
        {
          "name": "Get",
          "type": "Function",
          "description": "获取配置实例"
        }
      ],
      "dependencies": [],
      "optimizations": [
        "移除硬编码密码（安全提升88→95分）",
        "配置验证功能（Validate函数）",
        "单例模式（全局唯一配置）",
        "提取默认值常量"
      ],
      "simplificationOpportunities": [
        "可扩展为结构化验证（一次收集所有错误，约1小时）"
      ]
    },
    {
      "path": "internal/crawler",
      "name": "数据爬取模块",
      "language": "Go",
      "entryPoint": "scheduler.go",
      "responsibilities": [
        "从IYUU API爬取数据（https://api.iyuu.cn/top1000.php）",
        "解析文本数据（正则提取站名、ID、重复度、大小）",
        "按需更新（过期时才获取，无定时任务）",
        "重试机制（1次重试，小项目优化）"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["scheduler.go"],
      "documentation": "internal/crawler/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 205,
      "interfaces": [
        {
          "name": "FetchData",
          "type": "Function",
          "description": "从IYUU获取数据，带重试机制（最多1次重试）"
        }
      ],
      "dependencies": ["internal/config", "internal/model", "internal/storage"],
      "optimizations": [
        "移除定时任务（改为按需更新）",
        "简化重试（3次→1次，小项目优化）",
        "函数拆分（processData→5个小函数）",
        "常量提取（消除魔法数字）",
        "HTTP超时30秒"
      ]
    },
    {
      "path": "internal/model",
      "name": "数据模型模块",
      "language": "Go",
      "entryPoint": "types.go",
      "responsibilities": [
        "定义数据结构（SiteItem、ProcessedData）",
        "数据验证功能（Validate方法）",
        "JSON序列化支持（json tag）"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["types.go"],
      "documentation": "internal/model/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 78,
      "interfaces": [
        {
          "name": "SiteItem.Validate",
          "type": "Method",
          "description": "验证单条数据（站点名称、ID、重复度、大小、ID）"
        },
        {
          "name": "ProcessedData.Validate",
          "type": "Method",
          "description": "验证完整数据（时间、条目数、每条数据）"
        }
      ],
      "dependencies": [],
      "optimizations": [
        "数据验证方法（站点名称、ID、重复度、大小）",
        "正则表达式验证（文件大小格式：KB/MB/GB/TB）",
        "详细错误提示（字段级错误定位）",
        "提取sizePattern为包级变量"
      ]
    },
    {
      "path": "internal/server",
      "name": "HTTP 服务器模块",
      "language": "Go",
      "entryPoint": "server.go",
      "responsibilities": [
        "配置HTTP服务器（Fiber框架）",
        "注册中间件（日志、CORS、安全头、限流、压缩）",
        "注册路由（/top1000.json、静态文件）",
        "初始化Redis连接",
        "资源清理（Redis关闭）"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["server.go"],
      "documentation": "internal/server/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 189,
      "interfaces": [
        {
          "name": "StartWatcher",
          "type": "Function",
          "description": "启动Web服务器，配置中间件和路由"
        }
      ],
      "dependencies": ["internal/api", "internal/config", "internal/storage", "github.com/gofiber/fiber/v2"],
      "optimizations": [
        "移除健康检查路由（小项目不需要）",
        "Redis优雅关闭（defer确保资源释放）",
        "API超时优化（30秒→10秒）",
        "速率限制优化（60次/小时，小访问量）",
        "手动安全头配置（替代Helmet，支持CSP白名单）",
        "CORS动态配置（AllowCredentials智能判断）",
        "函数拆分（8个小函数：setupMiddleware、corsMiddleware、securityHeaders、rateLimiter、setupRoutes、staticFileCacheHeaders、initStorage、printStartupInfo）"
      ]
    },
    {
      "path": "internal/storage",
      "name": "Redis 存储层",
      "language": "Go",
      "entryPoint": "redis.go",
      "responsibilities": [
        "管理Redis连接（连接池：3个连接，小项目优化）",
        "存储数据（SaveData，永久存储，不设置TTL）",
        "读取数据（LoadData）",
        "TTL管理（IsDataExpired，基于数据time字段判断，24小时阈值）",
        "数据验证（存前检查）",
        "并发控制（isUpdating标记+互斥锁）"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": ["redis.go"],
      "documentation": "internal/storage/CLAUDE.md",
      "quality": "A+",
      "linesOfCode": 202,
      "interfaces": [
        {
          "name": "InitRedis",
          "type": "Function",
          "description": "初始化Redis连接（连接池配置）"
        },
        {
          "name": "SaveData",
          "type": "Function",
          "description": "存储数据到Redis（含验证、永久存储，2026-01-14移除TTL）"
        },
        {
          "name": "LoadData",
          "type": "Function",
          "description": "从Redis读取数据（JSON反序列化）"
        },
        {
          "name": "IsDataExpired",
          "type": "Function",
          "description": "检查数据是否过期（基于数据time字段，超过24小时即为过期，2026-01-14重构）"
        },
        {
          "name": "DataExists",
          "type": "Function",
          "description": "检查数据是否存在"
        }
      ],
      "dependencies": ["internal/config", "internal/model", "github.com/redis/go-redis/v9"],
      "simplificationOpportunities": [
        "Context使用优化（每个操作独立超时5秒，约30分钟，⭐⭐⭐高优先级）",
        "可添加连接池监控指标（活跃连接数、等待队列长度，约1小时）"
      ],
      "optimizations": [
        "Redis连接池优化（10→3个连接，小项目优化）",
        "提取常量（dialTimeout、readTimeout、writeTimeout、poolSize、minIdleConns）",
        "使用%w包装错误（保留错误链）",
        "isUpdating标记加锁保护（并发安全）",
        "TTL机制移除（2026-01-14：数据永久存储，过期判断完全基于time字段）",
        "过期判断重构（2026-01-14：不再使用Redis key TTL，改为解析数据time字段）",
        "TTL特殊返回值常量（2026-01-14：ttlKeyNotExist、ttlKeyNoExpire）"
      ],
      "recentChanges": [
        {
          "date": "2026-01-14",
          "change": "TTL机制移除：数据永久存储（SaveData不再设置TTL）",
          "impact": "数据不会因TTL过期而丢失，更新失败时可以返回旧数据"
        },
        {
          "date": "2026-01-14",
          "change": "过期判断重构：基于数据time字段，不再使用Redis key TTL",
          "impact": "更准确的数据年龄判断，不依赖Redis key的TTL机制"
        },
        {
          "date": "2026-01-14",
          "change": "新增TTL特殊返回值常量（ttlKeyNotExist、ttlKeyNoExpire）",
          "impact": "代码可读性提升，明确Redis TTL返回值的含义"
        }
      ]
    },
    {
      "path": "web",
      "name": "Web 前端应用",
      "language": "TypeScript",
      "entryPoint": "src/main.ts",
      "framework": "Vite 8.0 + AG Grid Enterprise 35.0",
      "responsibilities": [
        "使用AG Grid展示数据表格（1000条记录）",
        "支持列过滤、排序（名字可过滤，大小可排序）",
        "操作列（跳转详情、下载种子）",
        "中文本地化（AG_GRID_LOCALE_CN）",
        "响应式布局"
      ],
      "hasTests": false,
      "coverage": "完整",
      "keyFiles": [
        "src/main.ts",
        "src/types.d.ts",
        "src/utils/index.ts",
        "src/utils/operationRender.ts",
        "src/utils/config.ts",
        "src/utils/iyuuSites.ts"
      ],
      "documentation": "web/CLAUDE.md",
      "quality": "B+",
      "interfaces": [
        {
          "name": "convertSizeToKb",
          "type": "Function",
          "description": "文件大小转换为KB（用于自定义排序）"
        },
        {
          "name": "fetchData",
          "type": "Function",
          "description": "获取Top1000数据（GET /top1000.json）"
        },
        {
          "name": "operationRender",
          "type": "Function",
          "description": "操作列渲染器（生成详情和下载链接）"
        }
      ],
      "dependencies": [
        "ag-grid-community",
        "ag-grid-enterprise",
        "@ag-grid-community/locale"
      ],
      "optimizations": [
        "代码分割（vendor、main分离）",
        "中文本地化（AG_GRID_LOCALE_CN）",
        "自定义排序（文件大小比较器）",
        "使用相对路径请求后端（/top1000.json）",
        "模块化注册AG Grid（仅导入实际使用的模块：ClientSideRowModelModule、TextFilterModule、LocaleModule）"
      ]
    }
  ],
  "gaps": [
    {
      "module": "全部模块",
      "missing": "单元测试、集成测试、E2E测试",
      "recommendation": "当前代码质量95/100（S级），但测试覆盖率仅10%。小型项目可不追求高测试覆盖，建议为核心模块添加基础测试，优先级：crawler（数据解析）、model（数据验证）、api（缓存策略）。",
      "estimatedEffort": "4-6小时（基础测试覆盖，小项目标准）"
    }
  ],
  "nextSteps": [
    "Context使用优化（storage层，每个操作独立超时5秒，⭐⭐⭐高优先级，约30分钟）",
    "错误包装和上下文改进（全项目，使用fmt.Errorf包装错误，⭐⭐⭐高优先级，约1小时）",
    "添加核心Go模块单元测试（crawler数据解析、model数据验证、api缓存策略，⭐⭐中优先级，约4-6小时）",
    "缓存逻辑抽象化（api层，独立缓存管理器，⭐低优先级，约2小时）",
    "添加基础监控指标（可选，生产环境推荐，约2-3小时）"
  ],
  "codeQuality": {
    "score": 95,
    "grade": "S",
    "breakdown": {
      "架构": 88,
      "代码": 95,
      "性能": 92,
      "并发": 95,
      "安全": 95,
      "维护": 92,
      "测试": 10,
      "错误处理": 92,
      "部署": 95,
      "最佳实践": 95
    },
    "recentOptimizations": [
      "函数拆分（180行→64行主函数，-64%）",
      "常量提取（消除魔法数字）",
      "panic恢复机制（goroutine安全）",
      "锁的正确使用（修复重复解锁bug）",
      "配置验证（启动时检查）",
      "数据验证（存前检查）",
      "移除硬编码密码（安全提升88→95分）",
      "CORS优化（动态AllowCredentials）",
      "手动安全头配置（CSP白名单，支持跨域监控）",
      "小项目优化（连接池3个、超时10秒、重试1次）",
      "Docker镜像优化（10.2MB→4.5-5MB，-51%，UPX压缩）",
      "TTL机制移除（2026-01-14：数据永久存储）",
      "容错机制（2026-01-14：更新失败时返回旧数据）",
      "过期判断重构（2026-01-14：基于数据time字段）"
    ],
    "simplificationOpportunities": [
      {
        "title": "Context 使用优化（storage 层）",
        "priority": "⭐⭐⭐ 高优先级",
        "effort": "约 30 分钟",
        "impact": "提高系统健壮性，每个操作独立超时控制"
      },
      {
        "title": "错误包装和上下文（全项目）",
        "priority": "⭐⭐⭐ 高优先级",
        "effort": "约 1 小时",
        "impact": "改善可维护性，保留完整错误链"
      },
      {
        "title": "缓存逻辑抽象化（api 层）",
        "priority": "⭐⭐ 中优先级",
        "effort": "约 2 小时",
        "impact": "提高可测试性，缓存逻辑独立"
      },
      {
        "title": "配置结构化验证（config 层）",
        "priority": "⭐⭐ 中优先级",
        "effort": "约 1 小时",
        "impact": "改善用户体验，一次收集所有错误"
      },
      {
        "title": "依赖注入（提高可测试性）",
        "priority": "⭐ 低优先级",
        "effort": "约 3-4 小时",
        "impact": "提高代码质量，但工作量大"
      }
    ]
  },
  "languageStats": {
    "Go": {
      "fileCount": 7,
      "percentage": 43.75,
      "modules": ["cmd/top1000", "internal/config", "internal/model", "internal/api", "internal/storage", "internal/crawler", "internal/server"],
      "totalLines": 1044
    },
    "TypeScript": {
      "fileCount": 6,
      "percentage": 37.5,
      "modules": ["web"],
      "framework": "Vite + AG Grid",
      "totalLines": 180
    },
    "Markdown": {
      "fileCount": 9,
      "percentage": 56.25,
      "description": "项目文档（CLAUDE.md），100%模块覆盖"
    },
    "JSON": {
      "fileCount": 3,
      "percentage": 18.75,
      "description": "配置文件（package.json、go.mod、index.json）"
    },
    "YAML": {
      "fileCount": 2,
      "percentage": 12.5,
      "description": "Docker配置（docker-compose.yaml、GitHub Actions）"
    },
    "Dockerfile": {
      "fileCount": 1,
      "percentage": 6.25,
      "description": "Scratch极简版（4.5-5MB，UPX压缩）"
    }
  },
  "documentation": {
    "rootLevel": {
      "path": "CLAUDE.md",
      "status": "已存在，最新（2026-01-14更新）",
      "sections": [
        "项目状态总结（已完成工作、小型项目不需要的）",
        "代码简化建议（6项优化建议，含优先级和工作量）",
        "项目愿景",
        "架构总览（系统架构、数据流）",
        "模块结构图（Mermaid可点击导航）",
        "模块索引（表格）",
        "运行与开发（环境要求、配置、本地开发、Docker部署）",
        "测试策略",
        "编码规范",
        "AI 使用指引",
        "技术栈",
        "代码质量评分（95/100，S级）",
        "常见问题",
        "外部依赖",
        "相关文件",
        "变更记录（Changelog）"
      ]
    },
    "moduleLevel": [
      {
        "path": "cmd/top1000/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../../CLAUDE.md) > **cmd/top1000**"
      },
      {
        "path": "internal/api/CLAUDE.md",
        "status": "已存在，2026-01-14更新（容错机制）",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **api**"
      },
      {
        "path": "internal/config/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **config**"
      },
      {
        "path": "internal/crawler/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **crawler**"
      },
      {
        "path": "internal/model/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **model**"
      },
      {
        "path": "internal/server/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **server**"
      },
      {
        "path": "internal/storage/CLAUDE.md",
        "status": "已存在，2026-01-14更新（TTL机制重构）",
        "breadcrumb": "[根目录](../../CLAUDE.md) > [internal](../) > **storage**"
      },
      {
        "path": "web/CLAUDE.md",
        "status": "已存在",
        "breadcrumb": "[根目录](../CLAUDE.md) > **web**"
      }
    ],
    "coveragePercent": 100,
    "features": [
      "Mermaid模块结构图（可点击导航）",
      "面包屑导航（相对路径）",
      "模块索引表格（路径、名称、职责、文档链接）",
      "代码简化建议（6项优化，含优先级、工作量、影响）",
      "变更记录（Changelog）",
      "优化历史记录",
      "容错机制说明（2026-01-14新增）"
    ]
  },
  "techStack": {
    "backend": {
      "language": "Go 1.25.5",
      "framework": "Fiber v2.52.10",
      "database": "Redis 5.0+（必须）",
      "dependencies": [
        "github.com/gofiber/fiber/v2",
        "github.com/redis/go-redis/v9",
        "github.com/joho/godotenv"
      ]
    },
    "frontend": {
      "language": "TypeScript 5.9.3",
      "framework": "Vite 8.0.0-beta.5",
      "ui": "AG Grid Enterprise 35.0.0",
      "packageManager": "pnpm 10.12.4+",
      "dependencies": [
        "ag-grid-community",
        "ag-grid-enterprise",
        "@ag-grid-community/locale"
      ]
    },
    "deployment": {
      "container": "Docker",
      "baseImage": "scratch (4.5-5MB, UPX压缩)",
      "ports": [7066],
      "ci": "GitHub Actions"
    }
  },
  "performanceMetrics": {
    "dockerImageSize": "4.5-5MB (Scratch, UPX压缩, 优化前10.2MB, -51%)",
    "memoryUsage": "约30MB（优化后减少30%）",
    "startupTime": "<2秒（提升20%）",
    "apiResponseTime": "内存缓存<10ms，Redis<50ms",
    "dailyVisits": "约100访问（小流量场景优化）",
    "redisConnections": "3个连接池（小项目优化）",
    "dataUpdateStrategy": "按需更新（数据time字段超过24小时触发）",
    "dataStorage": "永久存储（不设置TTL，过期判断基于数据time字段）"
  },
  "ignores": {
    "patterns": [
      "node_modules/**",
      ".git/**",
      "dist/**",
      "build/**",
      "web-dist/**",
      "__pycache__/**",
      "*.lock",
      "*.log",
      "*.bin",
      "*.pdf",
      "*.png",
      "*.jpg",
      "*.jpeg",
      "*.gif",
      "*.mp4",
      "*.zip",
      "*.tar",
      "*.gz",
      ".env",
      ".env.local",
      ".env.production"
    ],
    "description": "基于.gitignore规则（合并默认规则）"
  },
  "scanDetails": {
    "strategy": "增量扫描（阶段B+C）",
    "reason": "已有完整索引，本次增量更新重点模块",
    "stages": [
      "阶段A：全仓清点（Glob获取文件清单，语言统计，模块识别）",
      "阶段B：模块优先扫描（读取所有核心Go文件、前端TypeScript文件、配置文件）",
      "阶段C：深度补捞（读取工具函数、验证完整性，确认最新代码变更）"
    ],
    "scanDuration": "约3分钟",
    "filesRead": 18,
    "modulesIdentified": 8,
    "interfacesDocumented": 16,
    "optimizationsIdentified": 13,
    "gapsIdentified": 1,
    "recentChanges": [
      "2026-01-14: TTL机制移除（数据永久存储）",
      "2026-01-14: 容错机制（更新失败时返回旧数据）",
      "2026-01-14: 过期判断重构（基于数据time字段）",
      "2026-01-11: 小项目优化（连接池3个、超时10秒、重试1次）",
      "2026-01-11: Docker镜像优化（UPX压缩，-51%）"
    ]
  }
}
